<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <!-- <meta name="viewport" content="width=device-width, initial-scale=1.0"> -->
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Pesan Terakhir Dari Toro</title>
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');

        @font-face {
            font-family: 'VHS Gothic';
            src: url('fonts/vhs-gothic.ttf') format('truetype');
            font-weight: normal;
            font-style: normal;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            user-select: none; /* Prevent text selection */
            -webkit-user-select: none; /* Safari */
            -moz-user-select: none; /* Firefox */
            -ms-user-select: none; /* IE10+ */
        }

        body {
            font-family: 'VHS Gothic', sans-serif;
            overflow: hidden;
            background: linear-gradient(135deg, #87CEEB 0%, #98FB98 100%);
        }

        .game-container {
            position: relative;
            width: 100vw;
            height: 100vh;
            background: linear-gradient(135deg, #B8E6B8 0%, #87CEEB 100%);
            overflow: hidden;
        }

        .background {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: url('img/bg2.jpg') no-repeat center center;
            background-size: cover;
        }

        .character-container {
            position: absolute;
            right: 50%;
            bottom: 60%;
            width: 300px;
            height: 400px;
            z-index: 10;
        }

        #img_char {
            width: 600px;
            transition: filter 0.2s ease, transform 0.2s ease;
            transform: scale(1);
        }

        .character {
            position: relative;
            width: 100px;
            height: 100px;
            transform: scale(1.1);
            filter: drop-shadow(2px 4px 8px rgba(0,0,0,0.2));
        }

        .dialogue-box {
            height: 250px;
            /* background: 
                linear-gradient(135deg, #F5DEB3 0%, #DEB887 100%),
                linear-gradient(to right, rgba(139, 69, 19, 0.1) 0%, rgba(160, 82, 45, 0.1) 100%); */
            /* border: 6px solid #8B4513; */
            /* border-radius: 25px; */
            /* box-shadow: 
                inset 0 4px 8px rgba(255, 255, 255, 0.3),
                0 8px 16px rgba(0, 0, 0, 0.3); */
            overflow: hidden;
        }

        .dialogue-box-parent {
            position: absolute;
            bottom: 0%;
            left: 0%;
            right: 0%;
            z-index: 20;
        }

        .dialogue-box::before {
            content: '';
            position: absolute;
            top: 8px;
            left: 8px;
            right: 8px;
            bottom: 8px;
            border: 2px solid #CD853F;
            border-radius: 18px;
            pointer-events: none;
            background: 
                linear-gradient(135deg, #181818 0%, #1F1F1F 100%),
                linear-gradient(to top, rgba(139, 69, 19, 0.1), rgba(160, 82, 45, 0.1));

            background-blend-mode: overlay;
            background-size: cover;
            background-repeat: no-repeat;

            -webkit-mask-image: linear-gradient(
                to right,
                rgba(0, 0, 0, 0.8) 0%,
                rgba(0, 0, 0, 0.8) 30%,
                rgba(0, 0, 0, 0.8) 50%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.8) 100%
            );
            -webkit-mask-size: 100% 100%;
            -webkit-mask-repeat: no-repeat;

            mask-image: linear-gradient(
                to right,
                rgba(0, 0, 0, 0.8) 0%,
                rgba(0, 0, 0, 0.8) 30%,
                rgba(0, 0, 0, 0.8) 50%,
                rgba(0, 0, 0, 0.8) 70%,
                rgba(0, 0, 0, 0.8) 100%
            );
            mask-size: 100% 100%;
            mask-repeat: no-repeat;
        }

        .nameplate {
            position: absolute;
            top: -15px;
            left: 30px;
            background: #8B4513;
            padding: 8px 20px;
            border-radius: 15px;
            border: 3px solid #8B4513;
            box-shadow: 0 4px 8px rgba(0, 0, 0, 0.2);
            z-index: 11;
        }

        @keyframes heartbeat {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }

        .character-name {
            display: inline-block;
            color: white;
            font-size: inherit;
            text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.7);
        }

        .dialogue-text {
            position: absolute;
            top: 30px;
            left: 50px;
            right: 50px;
            bottom: 40px;
            color: white;
            line-height: 1.6;
            overflow-y: auto;
            text-shadow: 1px 1px 0px rgba(255, 255, 255, 0.5);
            font-size: larger;
            overflow-y: auto;
            max-height: 300px; /* or any height */
        }
        
        /* Scrollbar Track */
        .dialogue-text::-webkit-scrollbar {
            width: 8px;
        }

        /* Scrollbar Thumb */
        .dialogue-text::-webkit-scrollbar-thumb {
            background-color: rgba(0, 0, 0, 0.4); /* dark semi-transparent */
            border-radius: 4px;
        }

        /* Scrollbar Track Background */
        .dialogue-text::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.1);
        }

        .btn-cancel {
            background: #1F1F1F !important;
            border: 1px solid #8B4513 !important;
        }

        
        .option-box {
            position: absolute;
            right: 10%;
            bottom: 300px;
            display: flex;
            flex-direction: column;
            gap: 10px;
            z-index: 99;
        }

        .choice {
            background: linear-gradient(to left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.8));
            border-radius: 10px;
            padding: 10px 16px;
            cursor: pointer;
            font-weight: bold;
            color: #fff;
            height: 65px;
            line-height: 45px;
            width: 500px;
            box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
            margin-bottom: 10px;
            overflow: hidden;
            position: relative;
            white-space: nowrap;
        }

        .choice span {
            display: inline-block;
            white-space: nowrap;
            will-change: transform;
        }

        .choice:hover {
            background: linear-gradient(to left, rgba(0, 0, 0, 0.2), rgba(0, 0, 0, 1));
            transform: scale(1.1);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.4);
            cursor: pointer;
        }

        .continue-indicator {
            position: absolute;
            bottom: 15px;
            right: 25px;
            color: #fff;
            font-size: 10px;
            opacity: 0.8;
            animation: blink 1.5s infinite;
        }

        #reset-popup {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8); /* gaming-style dark overlay */
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 999;
        }

        .popup-content {
            background: #1a1a1a;
            color: white;
            padding: 30px 40px;
            border-radius: 10px;
            text-align: center;
        }

        .popup-content button {
            background-color: #8B4513;
            border: none;
            color: white;
            padding: 10px 20px;
            cursor: pointer;
            margin-top: 20px;
            border-radius: 5px;
            font-family: 'VHS Gothic', sans-serif;
        }


        @keyframes blink {
            0%, 50% { opacity: 0.8; }
            51%, 100% { opacity: 0.3; }
        }

        .dialogue-controls {
            position: absolute;
            top: 10px;
            left: 10px;
            background: rgba(139, 69, 19, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 10px;
            z-index: 25;
        }

        .dialogue-controls2 {
            position: absolute;
            top: 10px;
            right: 10px;
            background: rgba(139, 69, 19, 0.7);
            color: white;
            padding: 8px 12px;
            border-radius: 10px;
            font-size: 10px;
            z-index: 25;
        }

        .typing-animation {
            animation: typing 3s steps(40, end) infinite;
        }

        .popup-textarea-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100vw;
            height: 100vh;
            background-color: rgba(0,0,0,0.6);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }

        .popup-textarea-box {
            background: #1F1F1F;
            padding: 20px;
            border-radius: 12px;
            width: 90%;
            max-width: 500px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
        }

        .popup-textarea-box textarea {
            width: 100%;
            resize: none;
            padding: 10px;
            font-size: 14px;
            border-radius: 6px;
            border: 1px solid #8B4513;
            background: #1F1F1F;
            color: white;
            margin-bottom: 12px;
        }

        .popup-textarea-box button {
            background: #8B4513;
            color: #fff;
            border: none;
            padding: 10px 16px;
            border: 1px solid #8B4513;
            font-weight: bold;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
        }

        @keyframes typing {
            from { width: 0; }
            to { width: 100%; }
        }

        /* Responsive design */
        @media (max-width: 768px) {
            .character-container {
                left: calc(50% - 160px); /* Half of the width */
                bottom: 40%;
                width: 250px;
                height: 350px;
            }
            
            .dialogue-box {
                height: 160px;
            }

            .dialogue-box-parent{
                top: 75%;
                margin-bottom: 15%;
            }
            
            .dialogue-text {
                font-size: 12px;
            }

            #img_char {
                width: 320px;
                transition: filter 0.2s ease, transform 0.2s ease;
                transform: scale(1);
            }

            .option-box {
                bottom: 27%;
                right: 0%;
                z-index: 99;
            }

            .choice{
                background: linear-gradient(to left, rgba(0, 0, 0, 0), rgba(0, 0, 0, 0.8));
                border-radius: 10px;
                padding: 10px 16px;
                cursor: pointer;
                transition: all 0.3s ease;
                font-weight: bold;
                color: #fff;
                height: 45px;
                line-height: 25px;
                width: 300px;
                box-shadow: 0 2px 6px rgba(0, 0, 0, 0.2);
                margin-bottom: 5px;
                font-size: small;
            }

            .choice:hover{
                transform: scale(1);
            }
        }
    </style>
</head>
<body>
    <div class="game-container">
        <!-- Background -->
        <div class="background"></div>
        
        <!-- Character -->
        <div class="character-container">
            <div class="character">
                <img src="img/poro-hi.png" alt="Poro" id="img_char">
            </div>
        </div>
        
        
        <div class="dialogue-controls">
            From : Toro
        </div>
        <div class="dialogue-controls2">
            To : Caca
        </div>

        <div class="option-box">
            <div class="choice" data-key="scene1" data-value="optionA">
                <span>Text1</span>
            </div>
        </div>
        
        <!-- Dialogue Box -->
        <div class="dialogue-box-parent" onclick="handleSpaceKey()">
            <div class="nameplate">
                <span class="character-name">Toro-kun</span>
            </div>
            <div class="dialogue-box">            
                <div class="dialogue-text" id="dialogueText">
                    <!-- Pesan -->
                </div>
                
                <div class="continue-indicator">
                    ► Tekan SPACE atau klik untuk lanjut
                </div>
            </div>
        </div>

        <div id="reset-popup" style="display: none;">
            <div class="popup-content">
                <p id="title-popup">Obrolan sudah selesai</p>
                <button onclick="resetDialogue()" id="button-popup">Mulai Lagi</button>
            </div>
        </div>

    </div>

    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
    <script>  
        document.querySelector('.option-box').style.display = 'none';

        const dialogues = [
            {
                char: "Poro",
                text: "Caca... alooo. Udah lama banget, ya?",
                imagePath: "img/poro/poro-hi.png"
            },
            {
                char: "Poro",
                text: "Kamu inget aku, nggak? Poro? Yang dulu jadi karakter di game Toro waktu nyatain perasaan ke kamu?", 
                imagePath: "img/poro/poro-bingung.png"
            },
            {
                char: "Poro",
                text: "Waktu itu aku muncul buat bantuin Toro ngomong. Sekarang... kayaknya tugas aku masih belum selesai.",
                imagePath: "img/poro/poro-nawar.png"
            },
            {
                char: "Poro",
                text: "Aku tau, kamu pasti inget Toro. Mungkin bukan dengan cara yang baik. Tapi dia di sini, dan dia cuma minta satu hal: bicara. Sekali ini aja.",
                imagePath: "img/poro/poro-sad.png"
            },
            {
                char: "Poro",
                text: "Dia nggak nyangka... kalau keputusannya dulu ternyata bikin kamu menjauh sejauh itu.",
                imagePath: "img/poro/poro-malu.png",
                choices: [
                    { 
                        text: "Dia baru sadar sekarang? ", 
                        value: "baru sadar", 
                        response: "Iya... kadang orang baru ngerti setelah semuanya bubar." 
                    },
                    { 
                        text: "Kenapa dia muncul lagi?", 
                        value: "muncul lagi", 
                        response: "Karena dia tau... ini mungkin kesempatan terakhir sebelum kamu benar-benar pergi lebih jauh." 
                    }
                ]
            },
            {
                char: "Poro",
                text: "Oke, aku serahin sama kalian yaa. Nenekku lagi latihan pingpong untuk 17-an, aku jadi pelatihnya. Hehe. Toro... giliran lu!",
                imagePath: "img/poro/poro-nawar.png"
            },
            {
                char: "Toro",
                text: "Halo Ca.. ", 
                imagePath: "img/toro/toro-hi.png"
            },
            {
                char: "Toro",
                text: "Hmm.. Sebelum semuanya, aku cuma mau bilang \n🎓 Selamat lulus, Caca.\n🎉 Dan selamat ulang tahun juga yaaa...",
                imagePath: "img/toro/toro-ok.png"
            },
            {
                char: "Toro",
                text: "Maaf kalau aku bukan orang pertama dan mungkin bukan orang yang kamu harapkan untuk ngucapin ini...", 
                imagePath: "img/toro/toro-pd.png"
            },
            {
                char: "Toro",
                text: `Tapi aku benar-benar berharap kamu bangga dengan diri kamu sendiri.\nKamu layak untuk itu. Lebih dari yang kamu pikirkan.`,
                imagePath: "img/toro/toro-pd.png"
            },
            {
                char: "Toro",
                text: "Ca... makasih udah dengerin aku sejauh ini. Aku tau aku bukan orang yang paling layak buat kamu temuin hari ini.",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Tapi ada satu hal yang selalu ganggu pikiranku: kenapa kamu menjauh sejauh itu?",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Aku sadar aku yang minta putus waktu itu. Tapi aku gak pernah ngira kamu bakal bener-bener ilang. Blokir semua. Gak ada ruang buat satu kata pun.",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Waktu itu aku pikir aku ngelakuin hal yang tepat. Aku takut jadi beban buat kamu. Aku takut kamu makin capek karena aku. Tapi sekarang aku mulai ngerasa... mungkin aku salah banget soal itu.",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Aku gak dateng buat nuntut apa-apa. Aku dateng buat minta maaf... karena ninggalin kamu dengan cara yang gak pantas. Dan buat ngerti, sebenernya hal bikin kamu sakit banget itu apa?",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Jadi, boleh gak... kamu bantu aku ngerti, Ca?",
                imagePath: "img/toro/toro-malu.png",
                choices: [
                    {
                        text: "Karena terlalu gampang mutusin",
                        value: "mudah_pergi",
                        response: "Toro: Aku pikir itu tindakan dewasa... tapi ternyata malah bikin kamu ngerasa ditinggalin, ya?",
                        imagePath: "img/toro/toro-sedih.png"
                    },
                    {
                        text: "Karena terkesan hidup aku cuma keputusan sepihak.",
                        value: "sepihak",
                        response: "Toro: Aku gak pernah ngelihatnya dari sisi itu... Aku kira itu cara paling aman. Tapi ternyata aku malah jadi arogan.",
                        imagePath: "img/toro/toro-sedih.png"
                    },
                    {
                        text: "Karena ganggu lagi waktu aku udah mulai belajar ngelepas.",
                        value: "terlambat_datang",
                        response: "Toro: Iya... aku egois banget ya. Dateng pas aku pengen, tanpa mikirin kamu udah sejauh apa ninggalin semua ini.",
                        imagePath: "img/toro/toro-sedih.png"
                    },
                    {
                        text: "Aku mau jelasin sendiri",
                        showTB: true
                    }
                ]
            },
            {
                char: "Toro",
                text: "Hmm... gitu yaa...",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Ca... makasih yaa. Serius. Karena hari ini kamu bilang sesuatu yang gak pernah aku berani tebak sendiri.",
                imagePath: "img/toro/toro-ok.png"
            },
            {
                char: "Toro",
                text: "Aku tau... mungkin ini udah terlambat. Tapi boleh gak... aku minta satu hal lagi?",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Dulu aku pergi karena aku takut... takut ngecewain kamu, takut jadi beban, takut kamu capek terus-menerus karena aku.",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Tapi waktu kamu beneran pergi... aku baru ngerti.",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Kamu bukan butuh aku jadi sempurna. Kamu cuma butuh aku buat bertahan. Buat tetep tinggal.",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Dan aku gagal. Karena aku terlalu sibuk mikir, sampe lupa... kamu udah berjuang sendiri dari awal, bahkan sebelum aku ada.",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Sekarang, setelah semua yang aku denger hari ini...",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Aku gak akan bilang aku berubah total. Tapi aku bisa pastiin satu hal: Aku udah belajar. Dan aku gak mau ulangin itu lagi.",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Kalau hari ini kamu bilang kamu gak mau lihat aku lagi — aku terima. Dan aku akan pergi. Tapi kalau... kalau ada ruang sekecil apapun...",
                imagePath: "img/toro/toro-sedih.png"
            },
            {
                char: "Toro",
                text: "Aku mau isi ruang itu. Bukan sebagai mantan. Tapi sebagai seseorang yang siap mencintai kamu dengan cara yang baru. Dengan cara yang seharusnya.",
                imagePath: "img/toro/toro-malu.png"
            },
            {
                char: "Toro",
                text: "Jadi, Ca... boleh gak, aku minta satu kesempatan lagi?",
                imagePath: "img/toro/toro-malu.png",
                choices: [
                    {
                        text: "Aku belum bisa, Toro. Tapi aku dengerin kamu, dan itu cukup untuk hari ini.",
                        value: "belum_bisa",
                        response: "Toro: Makasih... karena hari ini kamu dengerin. Dan kalau suatu hari kamu siap, aku masih di sini. Selalu di sini.",
                        music: "music/bunga_maaf.mp3"
                    },
                    {
                        text: "Aku gak tau harus bilang apa... tapi hatiku gak sekeras yang kamu kira.",
                        value: "harapan",
                        response: "Toro: Aku gak butuh jawaban hari ini. Denger kamu ngomong itu aja... udah bikin aku percaya, kalau ini belum benar-benar selesai.",
                        music: "video/missyou.mp4"
                    },
                    {
                        text: "Toro, semua ini... terlalu terlambat.",
                        value: "terlambat",
                        response: "Toro: Iya... aku ngerti. Kadang penyesalan datang pas semuanya udah hancur. Tapi aku tetap bersyukur... karena pernah punya kamu, walau cuma sebentar. \n Sebagai penutup, (nyalain suara yak) Bola kalo \"o\" nya diganti \"i\" jadi apa?",
                        music: "music/bila.mp3"
                    }
                ]
            }
        ];

        
        let currentDialogue = 0;
        let typingInProgress = false;
        let typingTimer;
        let current = dialogues[currentDialogue];
        let isOption = false;
        let isShowOption = false;
        let optionTextActive = "";
        let backSound = new Audio('sound/backsound.mp3');
        let typingSound = new Audio('sound/ketik.mp3');

        function typeWriter(text, element, speed = 50) {
            element.innerHTML = '';
            let i = 0;
            typingInProgress = true;

            clearInterval(typingTimer); // Clear any previous timer

            // Load typing sound
            typingSound.volume = 0.3;
            typingSound.playbackRate = 1.2;
            typingSound.loop = true; // 🔁 loop the audio while typing

            typingSound.play().catch(() => {}); 

            typingTimer = setInterval(() => {
                if (i < text.length) {
                    const char = text.charAt(i);

                    // Handle newline character manually
                    if (char === '\n') {
                        element.innerHTML += '<br>';
                    } else {
                        element.innerHTML += char;
                    }
                    
                    i++;
                } else {
                    clearInterval(typingTimer);
                    typingInProgress = false;

                    // ⏹️ Stop sound cleanly
                    typingSound.pause();
                    typingSound.currentTime = 0;

                    if (current.choices && !isOption) {
                        showChoices(current.choices);
                    } else {
                        optionBox.style.display = 'none';
                    }
                }
            }, speed);
        }


        function finishTypeWriter(text, element) {
            clearInterval(typingTimer);
            element.innerHTML = text.replace(/\n/g, "<br>");
            typingInProgress = false;
            typingSound.pause();
        }

        function updateCharacterImage(newSrc) {
            const img = document.getElementById("img_char");

            if (img.getAttribute("src") === newSrc) return;

            // Efek transisi: blur dan scale sedikit (tidak hilang)
            img.style.transform = "scale(0.98)";

            // Ganti gambar setelah efek blur aktif
            setTimeout(() => {
                img.setAttribute("src", newSrc);

                // Setelah gambar baru dimuat, pulihkan blur dan scale
                img.onload = () => {
                img.style.filter = "blur(0px)";
                img.style.transform = "scale(1)";
                };
            }, 200); // Match dengan CSS transition
        }

        let musicEnding = "";

        function nextDialogue() {
            if (currentDialogue < dialogues.length - 1) {
                currentDialogue++;
                current = dialogues[currentDialogue];

                if (current.imagePath) {
                    updateCharacterImage(current.imagePath);
                }


                if (current.choices) {
                    document.querySelector(".continue-indicator").style.display = 'none';
                } else {
                    document.querySelector(".continue-indicator").style.display = 'block';
                }

                typeWriter(current.text, dialogueText);
            } else {
                // End of dialogues, show reset popup
                if (musicEnding !== "") {
                    if (musicEnding.includes("music/")) {
                        // Fade out backsound (asumsi backsound adalah Audio object)
                        if (backSound) {
                            let fadeOutInterval = setInterval(() => {
                                if (backSound.volume > 0.05) {
                                    backSound.volume -= 0.05;
                                } else {
                                    backSound.volume = 0;
                                    backSound.pause();
                                    clearInterval(fadeOutInterval);
                                }
                            }, 100); // Mengurangi volume setiap 100ms
                        }

                        // Tunggu 2 detik (2000ms) lalu play musik baru dan tampilkan popup
                        setTimeout(() => {
                            backSound = new Audio(musicEnding);
                            backSound.volume = 0; // Mulai dari senyap
                            backSound.loop = true; // Aktifkan loop
                            backSound.play();

                            // Efek fade-in
                            let fadeInInterval = setInterval(() => {
                                if (backSound.volume < 0.95) {
                                    backSound.volume += 0.005;
                                } else {
                                    backSound.volume = 1;
                                    clearInterval(fadeInInterval);
                                }
                            }, 100); // Naikkan volume setiap 100ms

                            showResetPopup(); // Tampilkan popup setelah mulai play
                        }, 2000); // Delay awal 2 detik

                    } else {
                        showResetPopup(); // Jika tidak ada "music/", tetap tampilkan popup
                    }
                } else {
                    showResetPopup(); // Jika kosong, tetap tampilkan popup
                }

            }
        }

        document.addEventListener("DOMContentLoaded", function () {
            document.getElementById("title-popup").textContent = "Pesan Terakhir Untuk Caca";
            document.getElementById("button-popup").textContent = "Mulai";
            document.getElementById("reset-popup").style.display = "flex";
        });

        function showResetPopup() {
            document.getElementById('reset-popup').style.display = 'flex';
            const popupContent = document.querySelector('.popup-content');
            const existingMedia = popupContent.querySelector('img, video');
            if (existingMedia) existingMedia.remove();

            // Insert media based on condition
            if (musicEnding.includes("bunga_maaf")) {
                const img = document.createElement('img');
                img.src = "img/same_as_always.jpg";
                img.alt = "Bunga Maaf";
                img.style.width = "70%";
                img.style.marginBottom = "20px";
                img.style.height = "auto";
                popupContent.insertBefore(img, popupContent.firstChild);
            } else if (musicEnding.includes("miss")) {
                const video = document.createElement('video');
                video.src = "video/missyou.mp4";
                video.autoplay = true;     // Enable autoplay
                video.style.width = "70%";
                video.style.marginBottom = "20px";
                video.style.height = "auto";

                popupContent.insertBefore(video, popupContent.firstChild);

                backSound.pause();         // Pause background sound

                // Optional: Force play in case autoplay fails
                video.play().catch((err) => {
                    console.warn("Autoplay failed:", err);
                });

            }

            $("#title-popup").text("Obrolan sudah berakhir");
            $("#button-popup").text("Mulai Lagi");
        }

        function resetDialogue() {
            currentDialogue = 0;
            current = dialogues[currentDialogue];
            typeWriter(current.text, dialogueText);
            document.getElementById('reset-popup').style.display = 'none';
            backSound.pause();
            const video = document.querySelector('.popup-content video');
            if (video) {
                video.pause();
                video.currentTime = 0;  // Reset to beginning
                video.remove();         // Optional: remove from DOM
            }

            backSound = new Audio('sound/backsound.mp3');

            backSound.playbackRate = 1;
            backSound.loop = true;
            backSound.play().catch(() => {}); 

        }


        function startMarquee(span, container) {
            const containerWidth = container.clientWidth;
            const textWidth = span.scrollWidth + 20;

            if (textWidth <= containerWidth) return; // Tidak perlu marquee

            const delay = 2000; // jeda 2 detik
            const speed = 80; // px per detik
            const distance = textWidth - containerWidth;
            const duration = distance / speed * 1000; // dalam ms

            let phase = "start-delay";
            let startTime = null;

            function animate(timestamp) {
            if (!startTime) startTime = timestamp;

            let elapsed = timestamp - startTime;

            switch (phase) {
                case "start-delay":
                span.style.transform = `translateX(0)`;
                if (elapsed >= delay) {
                    phase = "scrolling";
                    startTime = timestamp;
                }
                break;

                case "scrolling":
                let progress = elapsed / duration;
                if (progress >= 1) {
                    span.style.transform = `translateX(${-distance}px)`;
                    phase = "end-delay";
                    startTime = timestamp;
                } else {
                    span.style.transform = `translateX(${-distance * progress}px)`;
                }
                break;

                case "end-delay":
                span.style.transform = `translateX(${-distance}px)`;
                if (elapsed >= delay) {
                    phase = "start-delay";
                    startTime = timestamp;
                }
                break;
            }

            requestAnimationFrame(animate);
            }

            // Mulai setelah delay awal
            setTimeout(() => {
            requestAnimationFrame(animate);
            }, delay);
        }



        let optionBox = document.querySelector('.option-box');
        
        function showChoices(choicesData) {
            // Clear existing choices
            optionBox.innerHTML = '';
            isShowOption = true;

            choicesData.forEach((choice) => {
                const choiceEl = document.createElement('div');
                choiceEl.className = 'choice';
                choiceEl.setAttribute('data-value', choice.value || '');
                choiceEl.setAttribute('data-response', choice.response || '');

                const span = document.createElement('span');
                span.innerText = choice.text;
                choiceEl.appendChild(span);

                            
                // Delay kecil agar render stabil
                setTimeout(() => startMarquee(span, choiceEl), 100);

                choiceEl.onclick = () => {
                    const key = choice.text;
                    const value = choice.value;
                    
                    if(choice.music){
                        musicEnding = choice.music;
                    }

                    // If showTB, show popup with textarea
                    if (choice.showTB === true) {
                        // Create popup container
                        const popup = document.createElement('div');
                        popup.className = 'popup-textarea-overlay';  // Style this overlay
                        popup.style.textAlign = 'right';

                        // Popup inner box
                        const popupBox = document.createElement('div');
                        popupBox.className = 'popup-textarea-box'; // Style this box

                        // Textarea
                        const textarea = document.createElement('textarea');
                        textarea.placeholder = 'Enter your response...';
                        textarea.rows = 4;
                        textarea.style.width = '100%';

                        // Submit button
                        const submitBtn = document.createElement('button');
                        submitBtn.innerText = 'Submit';

                        // Cancel button
                        const cancelBtn = document.createElement('button');
                        cancelBtn.innerText = 'Cancel';
                        cancelBtn.className = "btn-cancel";
                        cancelBtn.style.marginRight = '10px'; // spacing between buttons

                        // Button container (optional)
                        const buttonContainer = document.createElement('div');
                        buttonContainer.style.marginTop = '10px';
                        buttonContainer.appendChild(cancelBtn);
                        buttonContainer.appendChild(submitBtn);

                        // Append elements
                        popupBox.appendChild(textarea);
                        popupBox.appendChild(buttonContainer);
                        popup.appendChild(popupBox);
                        document.body.appendChild(popup);

                        cancelBtn.onclick = () => {
                            document.body.removeChild(popup);
                        };
                        // Submit click handler
                        submitBtn.onclick = () => {
                            const userInput = textarea.value.trim();

                            if (!userInput) {
                                alert('Please enter a response.');
                                return;
                            }

                            // Save choice with user input
                            fetch('backend/save_choice.php', {
                                method: 'POST',
                                headers: { 'Content-Type': 'application/json' },
                                body: JSON.stringify({ key, value: userInput })
                            })
                            .then(res => res.json())
                            .then(res => {
                                console.log('Choice saved:', res);
                                // Remove popup
                                document.body.removeChild(popup);
                                optionBox.style.display = 'none';
                                isShowOption = false;

                                if (choice.response !== undefined) {
                                    optionTextActive = choice.response;
                                    isOption = true;
                                    typeWriter(choice.response, dialogueText);
                                } else {
                                    nextDialogue();
                                }
                            })
                            .catch(err => {
                                console.error('Error saving choice:', err);
                                alert('Failed to save response, try again.');
                            });
                        };

                        // Stop here, don’t proceed with normal flow
                        return;
                    }

                    // Normal choice save flow
                    fetch('backend/save_choice.php', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ key, value })
                    })
                    .then(res => res.json())
                    .then(res => {
                        console.log('Choice saved:', res);
                    })
                    .catch(err => {
                        console.error('Error saving choice:', err);
                    });

                    optionBox.style.display = 'none';
                    isShowOption = false;

                    if (choice.response !== undefined) {
                        optionTextActive = choice.response;
                        isOption = true;
                        typeWriter(choice.response, dialogueText);
                    } else {
                        nextDialogue();
                    }
                };

                optionBox.appendChild(choiceEl);
            });

            optionBox.style.display = 'block';
        }




        // Keyboard controls
        document.addEventListener('keydown', (e) => {
            // Check if the focused element is a textarea or an input
            const activeElement = document.activeElement;
            const isTextInput = activeElement.tagName === 'TEXTAREA' ||
                                (activeElement.tagName === 'INPUT' && activeElement.type === 'text');

            if (isTextInput) return; // Let space behave normally in text input

            if (e.code === 'Space' && $("#reset-popup").css("display") !== "flex") {
                e.preventDefault();

                const currentText = !isOption ? dialogues[currentDialogue].text : optionTextActive;

                if (typingInProgress) {
                    finishTypeWriter(currentText, dialogueText);

                    if (current.choices && !isOption) {
                        showChoices(current.choices);
                    } else {
                        optionBox.style.display = 'none';
                        isShowOption = false;
                    }
                    
                } else {
                    if (!isShowOption) {
                        nextDialogue();
                    }
                }

                if (isOption) {
                    isOption = false;
                }
            }
        });


        function handleSpaceKey() {
            const event = new KeyboardEvent('keydown', { code: 'Space', key: ' ', keyCode: 32 });
            document.dispatchEvent(event);
        }

        
        // Initialize with typing effect
        // typeWriter(dialogues[currentDialogue].text, dialogueText);
        
        // Add subtle character breathing animation
        const character = document.querySelector('.character');
        setInterval(() => {
            character.style.transform = 'scale(1.1) translateY(-2px)';
            setTimeout(() => {
                character.style.transform = 'scale(1.1) translateY(0px)';
            }, 1000);
        }, 3000);
    </script>
</body>
</html>